

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>References specification &mdash; kerchunk  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=7ab3649f" />

  
    <link rel="shortcut icon" href="_static/kerchunk.ico"/>
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=5929fcd5"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Beyond Python" href="beyond.html" />
    <link rel="prev" title="Case studies" href="cases.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            kerchunk
              <img src="_static/kerchunk.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="test_example.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="detail.html">Detailed description</a></li>
<li class="toctree-l1"><a class="reference internal" href="cases.html">Case studies</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">References specification</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#version-0">Version 0</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1">Version 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#parquet-references">Parquet references</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="beyond.html">Beyond Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="nonzarr.html">Non-zarr uses</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference_aggregation.html">Aggregation special cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing to kerchunk</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced.html">Advanced Topics</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">kerchunk</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">References specification</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/spec.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="references-specification">
<h1>References specification<a class="headerlink" href="#references-specification" title="Link to this heading"></a></h1>
<p>The content of a reference set should match the given description here.
<code class="docutils literal notranslate"><span class="pre">fsspec</span></code>’s <code class="docutils literal notranslate"><span class="pre">ReferenceFileSystem</span></code> expects this kind of input.</p>
<section id="version-0">
<h2>Version 0<a class="headerlink" href="#version-0" title="Link to this heading"></a></h2>
<p>Prototype spec for the structure required by ReferenceFileSystem:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;key0&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;key1&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;protocol://target_url&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">10000</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>where:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">key0</span></code> includes data as-is (stored as text)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">key1</span></code> refers to a data file URL, the offset within the file (in bytes), and the length of the data item (in bytes).</p></li>
</ul>
<p>For example, Zarr data in this proposed spec might be represented as:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;.zgroup&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{\n    \&quot;zarr_format\&quot;: 2\n}&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;.zattrs&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{\n    \&quot;Conventions\&quot;: \&quot;UGRID-0.9.0\n\&quot;}&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;x/.zattrs&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{\n    \&quot;_ARRAY_DIMENSIONS\&quot;: [\n        \&quot;node\&quot;\n ...&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;x/.zarray&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{\n    \&quot;chunks\&quot;: [\n        9228245\n    ],\n    \&quot;compressor\&quot;: null,\n    \&quot;dtype\&quot;: \&quot;&lt;f8\&quot;,\n  ...&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;x/0&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;s3://bucket/path/file.nc&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">294094376</span><span class="p">,</span><span class="w"> </span><span class="mi">73825960</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Data can also be written as a JSON object instead of a string, in which case the value is interpreted as a JSON file. For example, the above could equivalently be written as:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;.zgroup&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;zarr_format&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;.zattrs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;Conventions&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;UGRID-0.9.0\n&quot;</span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;x/.zattrs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;_ARRAY_DIMENSIONS&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">]},</span>
<span class="w">  </span><span class="nt">&quot;x/.zarray&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;chunks&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">9228245</span><span class="p">],</span><span class="w"> </span><span class="nt">&quot;compressor&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;dtype&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;f8&quot;</span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;x/0&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;s3://bucket/path/file.nc&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">294094376</span><span class="p">,</span><span class="w"> </span><span class="mi">73825960</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="version-1">
<h2>Version 1<a class="headerlink" href="#version-1" title="Link to this heading"></a></h2>
<p>Metadata structure in JSON. We note, for future possible binary storage, that “version”, “gen” and “templates” should
be considered attributes, and “refs” as the data that ought to dominate the storage size. The previous definition,
Version 0, is compatible with the “refs” entry, but here we add features. It will also be possible to <em>expand</em>
this new enhanced spec into Version 0 format.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">required</span><span class="p">,</span> <span class="n">must</span> <span class="n">be</span> <span class="n">equal</span> <span class="n">to</span><span class="p">)</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;templates&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">optional</span><span class="p">,</span> <span class="n">zero</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">arbitrary</span> <span class="n">keys</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">&quot;template_name&quot;</span><span class="p">:</span> <span class="n">jinja</span><span class="o">-</span><span class="nb">str</span>
  <span class="p">},</span>
  <span class="s2">&quot;gen&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">optional</span><span class="p">,</span> <span class="n">zero</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">items</span><span class="p">)</span> <span class="p">[</span>
    <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">required</span><span class="p">)</span> <span class="n">jinja</span><span class="o">-</span><span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">required</span><span class="p">)</span> <span class="n">jinja</span><span class="o">-</span><span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">optional</span><span class="p">,</span> <span class="n">required</span> <span class="k">with</span> <span class="s2">&quot;length&quot;</span><span class="p">)</span> <span class="n">jinja</span><span class="o">-</span><span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">optional</span><span class="p">,</span> <span class="n">required</span> <span class="k">with</span> <span class="s2">&quot;offset&quot;</span><span class="p">)</span> <span class="n">jinja</span><span class="o">-</span><span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;dimensions&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">required</span><span class="p">,</span> <span class="n">one</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">arbitrary</span> <span class="n">keys</span><span class="p">)</span> <span class="p">{</span>
      <span class="s2">&quot;variable_name&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">required</span><span class="p">)</span>
        <span class="p">{</span><span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">optional</span><span class="p">)</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;stop&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">required</span><span class="p">)</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">optional</span><span class="p">)</span> <span class="nb">int</span><span class="p">}</span>
        <span class="n">OR</span>
        <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="s2">&quot;refs&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">optional</span><span class="p">,</span> <span class="n">zero</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">arbitrary</span> <span class="n">keys</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">&quot;key_name&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">required</span><span class="p">)</span> <span class="nb">str</span> <span class="n">OR</span> <span class="p">[</span><span class="n">url</span><span class="p">(</span><span class="n">jinja</span><span class="o">-</span><span class="nb">str</span><span class="p">)]</span> <span class="n">OR</span> <span class="p">[</span><span class="n">url</span><span class="p">(</span><span class="n">jinja</span><span class="o">-</span><span class="nb">str</span><span class="p">),</span> <span class="n">offset</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">length</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Where:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">jinja-str</span></code> is a string which will be rendered by jinja2 or its non-python equivalent; i.e., it may be
a literal string, or may include “{{..}}” annotations, where:</p>
<ul>
<li><p>for the values associated with a template_name, the variables are to be passed in reference URL strings that use this template</p></li>
<li><p>for the values within a “gen” object, variables come from the “dimensions” and “templates”</p></li>
</ul>
</li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">str</span></code> format of a reference value may be:</p>
<ul>
<li><p>a string starting “base64:”, which will be decoded to binary</p></li>
<li><p>any other string, interpreted as ascii data</p></li>
</ul>
</li>
<li><p>the str version of ref values indicates data, the one-element array a whole url, and the three-element version
a binary section of a url</p></li>
</ul>
<p>Here is an example</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;templates&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;u&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;server.domain/path&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;f&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{{c}}&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;gen&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;gen_key{{i}}&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://{{u}}_{{i}}&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;offset&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{{(i + 1) * 1000}}&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;length&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1000&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;dimensions&quot;</span><span class="p">:</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;i&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;stop&quot;</span><span class="p">:</span><span class="w">  </span><span class="mi">5</span><span class="p">}</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;refs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;key0&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;key1&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;http://target_url&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">10000</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">],</span>
<span class="w">      </span><span class="nt">&quot;key2&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;http://{{u}}&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">10000</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">],</span>
<span class="w">      </span><span class="nt">&quot;key3&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;http://{{f(c=&#39;text&#39;)}}&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">10000</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here the variable <code class="docutils literal notranslate"><span class="pre">i</span></code> takes the values <code class="docutils literal notranslate"><span class="pre">[0,</span> <span class="pre">1,</span> <span class="pre">2,</span> <span class="pre">3,</span> <span class="pre">4]</span></code>, which could have been provided in array form. Where there
is more than one variable, a cartesian product is formed.</p>
<p>This example evaluates to the Version 0 equivalent</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;key0&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;key1&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;http://target_url&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">10000</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;key2&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;http://server.domain/path&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">10000</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;key3&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;http://text&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">10000</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;gen_key0&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;http://server.domain/path_0&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;gen_key1&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;http://server.domain/path_1&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2000</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;gen_key2&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;http://server.domain/path_2&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">3000</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;gen_key3&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;http://server.domain/path_3&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">4000</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;gen_key4&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;http://server.domain/path_4&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>such that accessing, for instance, “key0” returns <code class="docutils literal notranslate"><span class="pre">b&quot;data&quot;</span></code> and accessing “gen_key0” returns 1000 bytes
from the given URL, at an offset of 1000.</p>
<script data-goatcounter="https://kerchunk.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script></section>
<section id="parquet-references">
<h2>Parquet references<a class="headerlink" href="#parquet-references" title="Link to this heading"></a></h2>
<p>Since JSON is rather verbose, it is easy with enough chunks to make a references file
that is too big: slow to load and heavy on memory. Although the former can be
alleviated by compression (I recommend Zstd), the latter cannot. This can
become particularly apparent during the combine phase when loading many reference sets.</p>
<p>The class <a class="reference external" href="https://filesystem-spec.readthedocs.io/en/latest/api.html?highlight=lazyreference#fsspec.implementations.reference.LazyReferenceMapper">fsspec.implementations.reference.LazyReferenceMapper</a> provides an
alternative <em>implementation</em>, and its on-disk layout effectively is a new reference
spec, and we describe it here. The class itself has a dict mapper interface, just
like the rendered references from JSON files; except that it assumes that it is
working on a zarr dataset. This is because the references are split into files, and
an array’s shape/chunk information is used to figure out which reference file
to load.</p>
<p>The following code</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lz</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">implementations</span><span class="o">.</span><span class="n">reference</span><span class="o">.</span><span class="n">LazyReferenceMapper</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s2">&quot;ref.parquet&quot;</span><span class="p">)</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="n">lz</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
<span class="n">d</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">g2</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;deep&quot;</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">g2</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
<span class="n">d</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>produces files</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>ref.parquet/deep/name/refs.0.parq
ref.parquet/name/refs.0.parq
ref.parquet/.zmetadata
</pre></div>
</div>
<p>Here, .zmetadata is all of the metadata of all of all subgroups/arrays (similar to
zarr “consolidated metadata”), with two top-level fields: “metadata” (dict[str, str]
all of the
zarr metadata key/values) and “record_size”, an integer set during <code class="docutils literal notranslate"><span class="pre">.create()</span></code>.</p>
<p>Each parquet file contains references within the corresponding path to where it is.
For example, key “name/0” will be the zeroth reference in “./name/refs.0.parq”. If
there are multiple dimensions, normal C indexing is used to find the Nth reference,
and there are up to “record_size” references (default 10000) in the first file;
reference &gt;10000,&lt;=20000 would be in “./name/refs.2.parquet”. Each file is (for now)
padded to record_size, but they compress really well.</p>
<p>Each row of the parquet data contains fields</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">path</span><span class="p">:</span> <span class="n">optional</span> <span class="nb">str</span><span class="o">/</span><span class="n">categorical</span><span class="p">,</span> <span class="n">remote</span> <span class="n">location</span> <span class="n">URL</span>
<span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start</span> <span class="n">location</span> <span class="n">of</span> <span class="n">block</span>
<span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">number</span> <span class="n">of</span> <span class="nb">bytes</span> <span class="ow">in</span> <span class="n">block</span>
<span class="n">raw</span><span class="p">:</span> <span class="n">optional</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">binary</span> <span class="n">data</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">raw</span></code> is populated, this is the data of the key. If <code class="docutils literal notranslate"><span class="pre">path</span></code> is
populated but size is 0, it is the whole file indicated (like a JSON [url] reference).
Otherwise, it is a byte block in the indicated file (like a JSON [url, offset, size] reference).
If both <code class="docutils literal notranslate"><span class="pre">raw</span></code> and <code class="docutils literal notranslate"><span class="pre">path</span></code> are NULL, the key does not exist.</p>
<p>We reserve the possibility to store small array data in .zmetadata instead
of creating a small/mostly empty parquet file for each.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="cases.html" class="btn btn-neutral float-left" title="Case studies" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="beyond.html" class="btn btn-neutral float-right" title="Beyond Python" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Martin Durant.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>